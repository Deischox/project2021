{% extends "landing/base.html" %} 
{% block content %}

{% for user, link in dict.items %} 
<a id="count_{{user}}" class="d-none">{{user.followerCount}}</a>
<div id="div_{{user}}" class="userdiv d-none">
    
        {% for i,l in link.items %}
    <li id="same_{{i}}">{{i}}**{{l}}</li>
        {% endfor %}
</div>  

{% endfor %}

<script src="https://cdn.jsdelivr.net/npm/p5@1.3.1/lib/p5.js"></script>
<script>
    
    let sf = 1; // scaleFactor
    let mx = 0, my = 0; // mouse coords;

    let startmx, startmy;
    let xend = 0, yend = 0;

    var infos = []
    var dragging = false;
    var a = 3;
    var users = "{{test}}"

    var pointDrag = false;



    function infoCircle(x,y,name,count)
    {
        this.x = x;
        this.y = y;
        this.name = name;
        this.count = count
        this.draged = false;
        this.infoopen = false;
        this.col = color(0,0,255);

        this.col = color(255,0,200);
        let div = createDiv('<p>'+this.name+'</p><p>Follower Count: '+this.count+'</p><p href="#" class="btn btn-primary">Go somewhere</p>');
        div.style('font-size', '16px');
        div.style('border','1px solid red')
        div.style('word-wrap','break-word')
        div.style('overflow','hidden')
        div.style('background-color','white')
        div.addClass('infoDiv')
        //testsdf
        div.addClass('d-none')


        this.display = function()
        {
            stroke(255);
            fill(this.col);
            ellipse(this.x, this.y, Math.max(this.count/1000,20), Math.max(this.count/1000,20));
            fill(0, 0, 0);
            textSize(Math.max(this.count/1000,20));
            text(this.name, this.x, this.y);
            textSize(12);
            
            
            div.position(this.x*sf+xend, this.y*sf+yend+(50+Math.max(this.count/1000,20)*sf));
            var sz = 16*sf 
            div.style('font-size', sz+'px');
            div.size(300*sf,100*sf);
        }

        this.clicked = function()
        {
            var d = dist(mouseX, mouseY, this.x*sf+xend, this.y*sf+yend)
            if(d <  Math.max(this.count/1000,20)/2*sf)
            {
                /*if(this.infoopen)
                {
                    this.infoopen = false;
                    div.addClass('d-none');
                }else{
                    this.infoopen = true;
                    div.removeClass('d-none')
                }*/
            }
        }

        this.moved = function()
        {
            var d = dist(mouseX, mouseY, this.x*sf+xend, this.y*sf+yend)
            if((d < Math.max(this.count/1000,20)/2*sf  && !dragging)|| this.dragging)
            {
                this.col = color(255,0,200);
                this.dragging = true;
                dragging = true;
                this.x = (mouseX-xend)/sf;
                this.y = (mouseY-yend)/sf;
                div.position(this.x*sf+xend, this.y*sf+yend+(Math.max(this.count/1000,20)*sf));
            }
        }

        this.release = function()
        {
            this.dragging = false;
        }
    }

   

    function setup() {
        createCanvas(windowWidth, 800);
        
        for(var i = 0; i < document.getElementsByClassName("userdiv").length; i++)
        {
            var x = random(width*0.2,width*0.75);
            var y = random(height*0.2,height*0.75);
            var name = document.getElementsByClassName("userdiv")[i].id.split("div_")[1]
            infos.push(new infoCircle(x,y,name,document.getElementById("count_"+name).innerHTML));
        }
    
    }

    function draw() {
    
    var abso = "{{absolute}}"
    
    background(125);
    translate(mx, my);
    scale(sf);
    for (var i = 0; i < infos.length; i++)
    {
        
        user = infos[i].name
        for(var v = 0; v < document.getElementById("div_"+user).children.length; v++)
        {
            for (var z = 0; z < infos.length; z++)
                {
                    if(infos[z].name == document.getElementById("div_"+user).children[v].innerHTML.split("**")[0])
                    {
                        
                        if(abso)
                        {
                            strokeWeight(document.getElementById("div_"+user).children[v].innerHTML.split("**")[1]/1000)
                        }else{
                            
                            strokeWeight(document.getElementById("div_"+user).children[v].innerHTML.split("**")[1]*100)
                        }
                        strokeWeight(document.getElementById("div_"+user).children[v].innerHTML.split("**")[1]/1000)
                        l = line(infos[z].x,infos[z].y,infos[i].x,infos[i].y)
                    }
                }
            
            
        }
        strokeWeight(1)
        
        
        
        
    }
        for (var i = 0; i < infos.length; i++)
        {
            
            infos[i].display();
            
        }
    }

    function mousePressed()
    {
        startmx = mouseX;
        startmy = mouseY;
        
        for (var i = 0; i < infos.length; i++)
            {

                infos[i].clicked();
            }
    }

    function mouseDragged()
    {
        
        if(!pointDrag)
        {

            for (var i = 0; i < infos.length; i++)
            {

                infos[i].moved();
            }
        }

            if(!dragging)
            {
                pointDrag = true;
            if(int(mouseX) - int(startmx) != mx)
            {
                mx = xend +(int(mouseX) - int(startmx));
            }
            if(int(mouseY) - startmy != my)
            {
                my = yend+(int(mouseY) - startmy);
            }

        }
    }

    function mouseReleased()
    {
        xend = mx;
        yend = my;
        for (var i = 0; i < infos.length; i++)
            {
                infos[i].release();
            }
        dragging = false;
        pointDrag = false;
    }

    function changeColor()
    {
        for (var i = 0; i < infos.length; i++)
            {
                infos[i].col = color(155,100,255);
            }
    }

    window.addEventListener("wheel", function(e) {
    if (e.deltaY > 0)
        sf *= 1.05;
    else
        sf *= 0.95;
    });
</script>

{% endblock content %}